# Team 01

## Хранилище данных

Изучение DWH и создание ETL-процесса.

## Introduction

- Для написания программ использовалась версия 15.2 PostgreSQL.
- Исходный код писался в DataGrip IDE.

## Rules of the day

- Убедитесь, что у вас есть собственная база данных и доступ к ней PostgreSQL;
- Задачи реализованы с учетом разделов «Разрешено» и «Запрещено» с перечисленными параметрами базы данных, типами баз данных, конструкциями SQL и т. д.;
- Загрузите [скрипт](materials/rush01_model.sql) с моделью базы данных здесь и примените его к своей базе данных (вы можете использовать командную строку с psql или просто запустить его через любую IDE, например DataGrip из JetBrains или pgAdmin из PostgreSQL);
- Пожалуйста, взгляните на логическое представление нашей модели базы данных.

![schema](misc/images/schema.png)

## Exercise 00

- Программа расположена в директории: ex00;
- Файл для сдачи: `team01_ex00.sql`;
- Языки: ANSI SQL.

Посмотрим на источники данных и первый логический уровень данных (ODS — Operational Data Store) в DWH.

![T01_05](misc/images/T01_05.png)

`User` Определение таблицы (в базе данных Green Source):

| Column Name | Description |
| ------ | ------ |
| ID | Primary Key |
| name | Имя пользователя |
| lastname | Фамилия пользователя |

`Currency` Определение таблицы (в базе данных Red Source):

| Column Name | Description |
| ------ | ------ |
| ID | Primary Key |
| name | Название валюты |
| rate_to_usd | Соотношение к доллару США |

`Balance` Определение таблицы (в базе данных Blue Source):

| Column Name | Description |
| ------ | ------ |
| user_id | “Virtual Foreign Key” в таблицу пользователей из другого источника |
| money |Сумма денег |
| type | Тип баланса (can be 0,1,...) |
| currency_id | “Virtual Foreign Key” в таблицу валют из другого источника |

Зеленые, красные и синие базы данных являются независимыми источниками данных и соответствуют шаблону микросервиса. Это означает, что существует высокий риск аномалий данных (представленных ниже).
- В таблицах нет согласованности данных. Это значит, что Пользователь есть, но в таблице «Баланс» нет строк, или наоборот, есть «Баланс», но в таблице «Пользователь» нет строк. Та же ситуация с таблицами Валюта и Баланс. (другими словами, между ними не существует явных внешних ключей)
- Возможны значения NULL для имени и фамилии в таблице пользователей.
- Все таблицы работают под управлением SQL-трафика OLTP (OnLine Transactional Processing). Это означает, что в определенный момент времени существует фактическое состояние данных, истории изменений не сохраняются для каждой таблицы.

Эти 3 перечисленные таблицы являются источниками данных для таблиц с аналогичными моделями данных в области DWH.

`User` Определение таблицы (в базе данных DWH):

| Column Name | Description |
| ------ | ------ |
| ID | Primary Key |
| name | Имя пользователя |
| lastname | Фамилия пользователя |

`Currency` Определение таблицы (в базе данных DWH):

| Column Name | Description |
| ------ | ------ |
| ID | Mocked Primary Key |
| name | Название валюты |
| rate_to_usd | Соотношение к доллару США |
| updated | Временная метка события из исходной базы данных |

`Mocked Primary Key`  означает, что есть дубликаты с тем же идентификатором, поскольку был добавлен новый обновленный атрибут, который преобразует нашу реляционную модель во временную реляционную модель.

Взгляните на образец данных для валюты «EUR» ниже. Этот пример основан на операторе SQL.

    SELECT *
    FROM Currency
    WHERE name = ‘EUR’
    ORDER BY updated DESC;

| ID | name | rate_to_usd | updated |
| ------ | ------ | ------ | ------ |
| 100 | EUR | 0.9 | 03.03.2022 13:31 |
| 100 | EUR | 0.89 | 02.03.2022 12:31 |
| 100 | EUR | 0.87 | 02.03.2022 08:00 |
| 100 | EUR | 0.9 | 01.03.2022 15:36 |
| ... | ... | ... | ... |

`Balance` Определение таблицы (в базе данных DWH):

| Column Name | Description |
| ------ | ------ |
| user_id | “Virtual Foreign Key” в таблицу пользователей из другого источника |
| money |Сумма денег |
| type | Тип баланса (can be 0,1,...) |
| currency_id | “Virtual Foreign Key” в таблицу валют из другого источника |
| updated | Временная метка события из исходной базы данных |

Взгляните на образец данных ниже. Этот пример основан на операторе SQL.

    SELECT *
    FROM Balance
    WHERE user_id = 103
    ORDER BY type, updated DESC;

| user_id | money | type | currency_id | updated |
| ------ | ------ | ------ | ------ | ------ |
| 103 | 200 | 0 | 100 | 03.03.2022 12:31 |
| 103 | 150 | 0 | 100 | 02.03.2022 11:29 |
| 103 | 15 | 0 | 100 | 03.03.2022 08:00 |
| 103 | -100 | 1 | 102 | 01.03.2022 15:36 |
| 103 | 2000 | 1 | 102 | 12.12.2021 15:36 |
| ... | ... | ... | ... |... |

Все таблицы в DWH также наследуют все аномалии из исходных таблиц.
- В таблицах нет согласованности данных.
- Возможны значения NULL для имени и фамилии в таблице пользователей.

Написан оператор SQL, который возвращает общий объем (сумму всех денег) транзакций из баланса пользователя, агрегированный по пользователю и типу баланса. Все данные обрабатываются, включая данные с аномалиями. Ниже представлена таблица столбцов результатов и соответствующая формула расчета.

| Output Column | Formula (pseudocode) |
| ------ | ------ |
| name | источник: user.name, если user.name равно NULL, тогда возвращается значение `not defined`. |
| lastname | источник: user.lastname, если user.lastname равно NULL, тогда возвращается значение `not defined` |
| type | источник: balance.type | 
| volume | источник: balance.money нужно суммировать все деньги “movements” | 
| currency_name | источник: currency.name, если currency.name равно NULL, тогда возвращается значение `not defined` | 
| last_rate_to_usd | источник: currency.rate_to_usd берется последняя currency.rate_to_usd для соответствующей валюты, если currency.rate_to_usd равна NULL, тогда возвращается 1 | 
| total_volume_in_usd | источник: volume , last_rate_to_usd. Производится умножение между volume and last_rate_to_usd |

Ниже представлен образец выходных данных. Результат сортируется по имени пользователя в порядке убывания, а затем по фамилии пользователя и типу баланса в порядке возрастания.

| name | lastname | type | volume | currency_name | last_rate_to_usd | total_volume_in_usd |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| Петр | not defined | 2 | 203 | not defined | 1 | 203 |
| Иван | Иванов | 1 | 410 | EUR | 0.9 | 369 |
| ... | ... | ... | ... | ... | ... | ... |

## Exercise 01

- Программа расположена в директории: ex01;
- Файл для сдачи: `team01_ex01.sql`;
- Языки: ANSI SQL.

Прежде чем глубже погрузиться в эту задачу, необходимо применить приведенные ниже инструкции INSERT.

`insert into currency values (100, 'EUR', 0.85, '2022-01-01 13:29');`
`insert into currency values (100, 'EUR', 0.79, '2022-01-08 13:29');`

Написан оператор SQL, который возвращает всех пользователей, все транзакции баланса (в этой задаче игнорируются валюты, у которых нет ключа в таблице «Валюта») с названием валюты и расчетным значением валюты в долларах США на ближайший день.

Ниже представлена таблица столбцов результатов и соответствующая формула расчета.

| Output Column | Formula (pseudocode) |
| ------ | ------ |
| name | источник: user.name, если user.name равен NULL, тогда возвращается значение `not defined` |
| lastname | источник: user.lastname, если user.lastname равен NULL, тогда возвращается значение `not defined` |
| currency_name | источник: currency.name | 
| currency_in_usd | задействованные источники: currency.rate_to_usd, currency.updated, balance.updated. Взгляните на графическую интерпретацию формулы ниже.| 

![T01_06](misc/images/T01_06.png)

- нужно найти ближайший курс валюты в прошлом (t1)
- если t1 пусто (означает отсутствие каких-либо курсов в прошлом), то найдите ближайший курс_к_долларам валюты в будущем (t2)
- используйте курс t1 ИЛИ t2 для расчета валюты в формате USD

Ниже представлен образец выходных данных. Результат отсортирован по имени пользователя в порядке убывания, а затем по фамилии пользователя и названию валюты в порядке возрастания.

| name | lastname | currency_name | currency_in_usd |
| ------ | ------ | ------ | ------ |
| Иван | Иванов | EUR | 150.1 |
| Иван | Иванов | EUR | 17 |
| ... | ... | ... | ... |
