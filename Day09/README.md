# Day 09

## СУБД — это не просто таблицы

Создание и использование функциональных блоков в базах данных.

## Introduction

- Для написания программ использовалась версия 15.2 PostgreSQL.
- Исходный код писался в DataGrip IDE.

## Contents

1. [Exercise 00](#exercise-00)
2. [Exercise 01](#exercise-01)
3. [Exercise 02](#exercise-02)
4. [Exercise 03](#exercise-03)
5. [Exercise 04](#exercise-04)
6. [Exercise 05](#exercise-05)
7. [Exercise 06](#exercise-06)
8. [Exercise 07](#exercise-07)
9. [Exercise 08](#exercise-08)

## Rules of the day

- Убедитесь, что у вас есть собственная база данных и доступ к ней PostgreSQL.
- Загрузите [скрипт](materials/model.sql) с моделью базы данных здесь и примените его к своей базе данных. **Все изменения, которые были внесены в День 03 в упражнениях 07–13 и День 04 в упражнении 07, должны быть на месте (это похоже на то, как в реальном мире, когда применяется выпуск, и необходимо обеспечить согласованность с данными для новых изменений).**
- Логическое представление предоставленной модели базы данных:

![schema](misc/images/schema.png)


1. **pizzeria** (Таблица с доступными пиццериями)
- поле id - первичный ключ
- поле name - название пиццерий
- поле rating - средний рейтинг пиццерии (от 0 до 5 баллов)
2. **person** (Таблица с людьми, которые любят пиццу)
- поле id - первичный ключ
- поле name - имя человека
- поле age - возраст человека
- поле gender - половая принадлежность человека
- поле address - адрес человека
3. **menu** (Таблица с доступным меню и ценой на конкретную пиццу)
- поле id - первичный ключ
- поле pizzeria_id - внешний ключ от таблицы пиццерий
- поле pizza_name - название пиццы в пиццерии
- поле price - цена конкретной пиццы
4. **person_visits** (Таблица с информацией о посещениях пиццерии)
- поле id - первичный ключ
- поле person_id - внешний ключ от таблицы с людьми
- поле pizzeria_id - внешний ключ от таблицы пиццерий
- поле visit_date - дата (например: 01.01.2022) посещения человека
5. **person_order** (Таблица с информацией о заказах людей)
- поле id - первичный ключ
- поле person_id - внешний ключ от таблицы с людьми
- поле menu_id - внешний ключ от таблицы с меню
- поле order_date - дата (например: 01.01.2022) заказа человека

Посещение человека и заказ человека являются разными сущностями и не содержат никакой корреляции между данными. Например, клиент может находиться в одном ресторане (просто просматривая меню), а в это время сделать заказ в другом по телефону или через мобильное приложение. Или другой случай, просто оказаться дома и снова позвонить с заказом без всяких посещений.

## Exercise 00

- Программа расположена в директории: ex00;
- Файл для сдачи: `day09_ex00.sql`;
- Языки: SQL, DDL, DML.

Реализована функция аудита входящих изменений INSERT.

Создана функция `person_audit` с той же структурой, что и таблица person, но добавлено несколько дополнительных изменений. Взгляните на таблицу ниже с описаниями для каждого столбца.

| Column | Type | Description |
| ------ | ------ | ------ |
| created | timestamp with time zone | временная метка создания нового события. Значение по умолчанию — текущая временная метка и NOT NULL. |
| type_event | char(1) | возможное значение I (insert), D (delete), U (update). Значение по умолчанию ‘I’ и NOT NULL. Добавлено проверочное ограничение `ch_type_event` с возможными значениями «I», «U» и «D». |
| row_id |bigint | копия person.id. NOT NULL |
| name |varchar | копия person.name (никаких ограничений) |
| age |integer | копия person.age (никаких ограничений) |
| gender |varchar | копия person.gender (никаких ограничений) |
| address |varchar | копия person.address (никаких ограничений) |

Создана триггерная функция базы данных с именем `fnc_trg_person_insert_audit`, которая должна обрабатывать DML-трафик `INSERT` и делать копию новой строки в таблице person_audit.

Определен триггер базы данных с именем `trg_person_insert_audit` со следующими параметрами:
- триггер с “FOR EACH ROW” опцией;
- триггер с “AFTER INSERT”;
- название функции триггера fnc_trg_person_insert_audit.

Добавлен оператор `INSERT` в таблицу person:

`INSERT INTO person(id, name, age, gender, address) VALUES (10,'Damir', 22, 'male', 'Irkutsk');`

## Exercise 01

- Программа расположена в директории: ex01;
- Файл для сдачи: `day09_ex01.sql`;
- Языки: SQL, DDL, DML.

Продолжили реализацию нашего шаблона аудита для таблицы person. Определили триггер `trg_person_update_audit` и соответствующую функцию триггера `fnc_trg_person_update_audit` для обработки всего трафика `UPDATE` в таблице person. Сохранили СТАРЫЕ состояния всех значений атрибутов.

Применили приведенные ниже утверждения `UPDATE`.

`UPDATE person SET name = 'Bulat' WHERE id = 10;`
`UPDATE person SET name = 'Damir' WHERE id = 10;`

## Exercise 02

- Программа расположена в директории: ex02;
- Файл для сдачи: `day09_ex02.sql`;
- Языки: SQL, DDL, DML.

Обработали операторы `DELETE` и сделали копию СТАРЫХ состояний для всех значений атрибута. Создали триггер `trg_person_delete_audit` и соответствующую функцию триггера `fnc_trg_person_delete_audit`.

Применили приведенный ниже оператор SQL.

`DELETE FROM person WHERE id = 10;`

## Exercise 03

- Программа расположена в директории: ex03;
- Файл для сдачи: `day09_ex03.sql`;
- Языки: SQL, DDL, DML.

Для одной таблицы `person` существует 3 триггера. Объединили всю нашу логику с одним основным триггером с именем `trg_person_audit` и новой соответствующей триггерной функцией `fnc_trg_person_audit`.

Другими словами, весь трафик DML («INSERT», «UPDATE», «DELETE») должен обрабатываться из одного функционального блока. Явно определили отдельный блок IF-ELSE для каждого события (I, U, D)!

Выполнили следующие действия:
- удалили 3 старых триггера из таблицы person;
- удалили 3 три старых триггерных функции;
- выполнили `TRUNCATE` (или `DELETE`) всех строк в нашей таблице `person_audit`.

Повторно применили набор операторов DML:
`INSERT INTO person(id, name, age, gender, address)  VALUES (10,'Damir', 22, 'male', 'Irkutsk');`
`UPDATE person SET name = 'Bulat' WHERE id = 10;`
`UPDATE person SET name = 'Damir' WHERE id = 10;`
`DELETE FROM person WHERE id = 10;`

## Exercise 04

- Программа расположена в директории: ex04;
- Файл для сдачи: `day09_ex04.sql`;
- Языки: SQL, DDL, DML.

Как вы помните, были созданы два представления базы данных, чтобы отделить данные из таблиц людей по признаку пола.
Определили 2 SQL-функции (имейте в виду, а не pl/pgsql-функции) с именами.
- `fnc_persons_female` (возвращает лица женского пола)
- `fnc_persons_male` (возвращает лица мужского пола)

Для проверки функций сделали операторы, как показано ниже (удивительно! с функцией можно работать, как с виртуальной таблицей!).

    SELECT *
    FROM fnc_persons_male();

    SELECT *
    FROM fnc_persons_female();

## Exercise 05

- Программа расположена в директории: ex05;
- Файл для сдачи: `day09_ex05.sql`;
- Языки: SQL, DDL, DML.

Две функции из упражнения 04 требуют более общего подхода. Удалили эти функции из базы данных.

Написали общую SQL-функцию (имейте в виду, а не функцию pl/pgsql) с именем `fnc_persons`. Эта функция имеет параметр pgender `IN` со значением по умолчанию = ‘female’.

Для проверки функции сделали операторы, как показано ниже (вау! вы можете работать с функцией, как с виртуальной таблицей, но с большей гибкостью!).

    select *
    from fnc_persons(pgender := 'male');

    select *
    from fnc_persons();

## Exercise 06

- Программа расположена в директории: ex06;
- Файл для сдачи: `day09_ex06.sql`;
- Языки: SQL, DDL, DML.

Создали функцию pl/pgsql `fnc_person_visits_and_eats_on_date` на основе оператора SQL, которая находит названия пиццерий, в которых человек (параметр `IN` pperson со значением по умолчанию - "Дмитрий") посетил и купил пиццу на сумму меньше заданной суммы в рублях (параметр `IN` pprice со значением по умолчанию – 500) на определенную дату (параметр `IN` pdate со значением по умолчанию — 8 января 2022 года).

Для проверки функции созданы операторы, как показано ниже.

    select *
    from fnc_person_visits_and_eats_on_date(pprice := 800);

    select *
    from fnc_person_visits_and_eats_on_date(pperson := 'Anna',pprice := 1300,pdate := '2022-01-01');

## Exercise 07

- Программа расположена в директории: ex07;
- Файл для сдачи: `day09_ex07.sql`;
- Языки: SQL, DDL, DML.

Написали функцию `func_minimum` на SQL, у которой входным параметром является массив чисел, и функция возвращает минимальное значение.

Для проверки функции создан оператор, как показано ниже.

    SELECT func_minimum(VARIADIC arr => ARRAY[10.0, -1.0, 5.0, 4.4]);

## Exercise 08

- Программа расположена в директории: ex08;
- Файл для сдачи: `day09_ex08.sql`;
- Языки: SQL, DDL, DML.

Написали функцию `fnc_fibonacci` на SQL, которая имеет входной параметр pstop целочисленного типа (по умолчанию – 10), а выходные данные функции представляют собой таблицу со всеми числами Фибоначчи, меньшими, чем pstop.

Для проверки функции созданы операторы, как показано ниже.

    select * from fnc_fibonacci(100);
    select * from fnc_fibonacci();
